<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Discover Gozo Analytics Report</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            color: #333;
            line-height: 1.6;
            background: #fff;
        }

        .page {
            page-break-after: always;
            padding: 20mm;
        }

        .page:last-child {
            page-break-after: avoid;
        }

        /* Cover Page */
        .cover-page {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            text-align: center;
        }

        .cover-page h1 {
            font-size: 48px;
            margin-bottom: 20px;
            font-weight: 700;
        }

        .cover-page .subtitle {
            font-size: 24px;
            margin-bottom: 10px;
            opacity: 0.9;
        }

        .cover-page .period {
            font-size: 18px;
            margin-bottom: 40px;
            opacity: 0.8;
        }

        .cover-page .date {
            font-size: 14px;
            opacity: 0.7;
            margin-top: 60px;
        }

        /* Logo */
        .logo {
            max-width: 200px;
            height: auto;
            margin-bottom: 20px;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 8px;
            margin-bottom: 30px;
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .header-logo {
            max-width: 120px;
            height: auto;
        }

        .header-content {
            flex: 1;
        }

        .header h1 {
            font-size: 32px;
            margin-bottom: 10px;
        }

        .header .meta {
            font-size: 14px;
            opacity: 0.9;
        }

        /* Sections */
        .section {
            margin-bottom: 40px;
            page-break-inside: avoid;
        }

        .section-title {
            font-size: 24px;
            color: #667eea;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 3px solid #667eea;
            font-weight: 600;
        }

        .section-content {
            font-size: 14px;
            line-height: 1.8;
        }

        /* Metric Cards */
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin: 20px 0;
        }

        .metric-card {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .metric-card .value {
            font-size: 36px;
            font-weight: 700;
            color: #667eea;
            margin-bottom: 10px;
        }

        .metric-card .label {
            font-size: 14px;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* Lists */
        .insights-list, .recommendations-list {
            list-style: none;
            padding-left: 0;
        }

        .insights-list li, .recommendations-list li {
            padding: 12px;
            margin-bottom: 10px;
            background: #f8f9fa;
            border-left: 4px solid #667eea;
            border-radius: 4px;
        }

        .insights-list li::before {
            content: "\f0eb"; /* Font Awesome lightbulb icon */
            font-family: "Font Awesome 6 Free";
            font-weight: 900;
            margin-right: 8px;
            color: #667eea;
            display: inline-block;
        }

        .recommendations-list li::before {
            content: "\f00c"; /* Font Awesome check icon */
            font-family: "Font Awesome 6 Free";
            font-weight: 900;
            margin-right: 8px;
            color: #28a745;
            display: inline-block;
        }

        /* Tables */
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            font-size: 12px;
        }

        table th {
            background: #667eea;
            color: white;
            padding: 12px;
            text-align: left;
            font-weight: 600;
        }

        table td {
            padding: 10px 12px;
            border-bottom: 1px solid #e0e0e0;
        }

        table tr:hover {
            background: #f5f5f5;
        }

        /* Executive Summary */
        .executive-summary {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 8px;
            border-left: 5px solid #667eea;
            margin: 20px 0;
            font-size: 14px;
            line-height: 1.8;
        }

        /* Charts */
        .chart-container {
            position: relative;
            height: 300px;
            margin: 20px 0;
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .chart-title {
            font-size: 16px;
            font-weight: 600;
            color: #667eea;
            margin-bottom: 15px;
            text-align: center;
        }

        /* Footer */
        .footer {
            margin-top: 40px;
            padding-top: 20px;
            border-top: 2px solid #e0e0e0;
            text-align: center;
            font-size: 12px;
            color: #999;
        }

        /* Page Numbers */
        @page {
            margin: 20mm;
            @bottom-center {
                content: "Page " counter(page) " of " counter(pages);
                font-size: 10px;
                color: #999;
            }
        }

        /* Print Styles */
        @media print {
            .page {
                margin: 0;
                padding: 15mm;
            }
        }
    </style>
</head>
<body>
    <!-- Cover Page -->
    <div class="page cover-page">
        <img src="{{logoBase64}}" alt="Discover Gozo Logo" class="logo" style="max-width: 250px; height: auto; display: block; margin: 0 auto 30px auto;" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
        <h1 style="display: none;">Discover Gozo</h1>
        <div class="subtitle">Analytics Report</div>
        <div class="period">{{periodLabel}}</div>
        <div class="date">Generated: {{generatedAt}}</div>
    </div>

    <!-- Executive Summary -->
    <div class="page">
        <div class="section">
            <div class="section-title">Executive Summary</div>
            <div class="executive-summary">
                {{executiveSummary}}
            </div>
        </div>
    </div>

    <!-- Key Metrics -->
    <div class="page">
        <div class="section">
            <div class="section-title">Key Metrics</div>
            <div class="metrics-grid">
                <div class="metric-card">
                    <div class="value">{{sessionStats.total_sessions}}</div>
                    <div class="label">Total Sessions</div>
                </div>
                <div class="metric-card">
                    <div class="value">{{sessionStats.unique_users}}</div>
                    <div class="label">Unique Users</div>
                </div>
                <div class="metric-card">
                    <div class="value">{{sessionStats.avg_session_duration}}</div>
                    <div class="label">Avg Session (seconds)</div>
                </div>
                <div class="metric-card">
                    <div class="value">{{sessionStats.unique_sessions}}</div>
                    <div class="label">Unique Sessions</div>
                </div>
            </div>
        </div>
    </div>

    <!-- User Engagement Trends Chart -->
    <div class="page">
        <div class="section">
            <div class="section-title">User Engagement Trends</div>
            <div class="chart-container">
                <canvas id="engagementChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Daily Activity Chart -->
    <div class="page">
        <div class="section">
            <div class="section-title">Daily Activity Trends</div>
            <div class="chart-container">
                <canvas id="dailyChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Hourly Activity Chart -->
    <div class="page">
        <div class="section">
            <div class="section-title">Peak Usage Hours</div>
            <div class="chart-container">
                <canvas id="hourlyChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Device & Browser Usage Chart -->
    <div class="page">
        <div class="section">
            <div class="section-title">Device & Browser Usage</div>
            <div class="chart-container">
                <canvas id="deviceChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Top Places Chart -->
    <div class="page">
        <div class="section">
            <div class="section-title">Top 10 Most Viewed Places</div>
            <div class="chart-container">
                <canvas id="topPlacesChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Top Categories Chart -->
    <div class="page">
        <div class="section">
            <div class="section-title">Category Popularity</div>
            <div class="chart-container">
                <canvas id="topCategoriesChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Search Analytics Chart -->
    <div class="page">
        <div class="section">
            <div class="section-title">Search Analytics</div>
            <div class="chart-container">
                <canvas id="searchChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Economic Activity Chart -->
    <div class="page">
        <div class="section">
            <div class="section-title">Economic Activity</div>
            <div class="chart-container">
                <canvas id="economicChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Tour Analytics Section -->
    <div class="page">
        <div class="section">
            <div class="section-title"><i class="fas fa-ship"></i> Tour Performance Analytics</div>
            
            <div class="chart-container">
                <h3>Most Viewed Tours</h3>
                <canvas id="mostViewedToursChart"></canvas>
            </div>
            
            <div class="chart-container">
                <h3>Most Booked Tours</h3>
                <canvas id="mostBookedToursChart"></canvas>
            </div>
            
            <div class="chart-container">
                <h3>Tour Revenue</h3>
                <canvas id="tourRevenueChart"></canvas>
            </div>
            
            <div class="chart-container">
                <h3>Tickets Sold per Tour</h3>
                <canvas id="ticketsSoldChart"></canvas>
            </div>
            
            <div class="chart-container">
                <h3>Checkout Abandonment</h3>
                <canvas id="checkoutAbandonmentChart"></canvas>
            </div>
            
            <div class="chart-container">
                <h3>Unpaid Tours</h3>
                <table class="data-table" id="unpaidToursTable">
                    <thead>
                        <tr>
                            <th>Tour Name</th>
                            <th>User</th>
                            <th>Amount</th>
                            <th>Date</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Merchant Analytics Section -->
    <div class="page">
        <div class="section">
            <div class="section-title"><i class="fas fa-store"></i> Merchant Performance Analytics</div>
            
            <div class="chart-container">
                <h3>Ticket Scans per Merchant</h3>
                <canvas id="merchantScansChart"></canvas>
            </div>
            
            <div class="chart-container">
                <h3>Revenue per Merchant</h3>
                <canvas id="merchantRevenueChart"></canvas>
            </div>
            
            <div class="chart-container">
                <h3>Reservations per Merchant</h3>
                <canvas id="merchantReservationsChart"></canvas>
            </div>
            
            <div class="chart-container">
                <h3>Unused Tickets per Merchant</h3>
                <canvas id="merchantUnusedChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Key Insights -->
    <div class="page">
        <div class="section">
            <div class="section-title">Key Insights</div>
            <ul class="insights-list">
                {{keyInsights}}
            </ul>
        </div>
    </div>

    <!-- Top Places -->
    <div class="page">
        <div class="section">
            <div class="section-title">Top Visited Places</div>
            <table>
                <thead>
                    <tr>
                        <th>Rank</th>
                        <th>Place Name</th>
                        <th>Views</th>
                    </tr>
                </thead>
                <tbody id="top-places-table">
                    <!-- Will be populated by JavaScript or server-side -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- Top Categories -->
    <div class="page">
        <div class="section">
            <div class="section-title">Top Categories</div>
            <table>
                <thead>
                    <tr>
                        <th>Category</th>
                        <th>Views</th>
                    </tr>
                </thead>
                <tbody id="top-categories-table">
                    <!-- Will be populated by JavaScript or server-side -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- Recommendations -->
    <div class="page">
        <div class="section">
            <div class="section-title">Recommendations</div>
            <ul class="recommendations-list">
                {{recommendations}}
            </ul>
        </div>
    </div>

    <!-- Opportunities -->
    <div class="page">
        <div class="section">
            <div class="section-title">Growth Opportunities</div>
            <ul class="insights-list">
                {{opportunities}}
            </ul>
        </div>
    </div>

    <!-- Footer -->
    <div class="footer">
        <p>This report was generated automatically by the Discover Gozo Analytics System</p>
        <p>For questions or support, please contact the development team</p>
    </div>

    <script>
        // Populate tables with data and create charts
        (function() {
            try {
                // Parse data - handle escaped JSON strings
                let topPlaces, topCategories, dailyStats, hourlyStats, deviceStats, searchAnalytics, economicActivity;
                
                try {
                    // Unescape and parse JSON
                    const unescapeJson = (str) => {
                        if (!str || str === 'undefined' || str === 'null' || str === '') return [];
                        try {
                            // Remove extra escaping
                            const unescaped = str.replace(/\\\\/g, '\\').replace(/\\'/g, "'").replace(/\\"/g, '"');
                            return JSON.parse(unescaped);
                        } catch (e) {
                            console.error('JSON parse error:', e, 'String:', str.substring(0, 100));
                            return [];
                        }
                    };
                    
                    topPlaces = unescapeJson('{{topPlaces}}');
                    topCategories = unescapeJson('{{topCategories}}');
                    dailyStats = unescapeJson('{{dailyStats}}');
                    hourlyStats = unescapeJson('{{hourlyStats}}');
                    deviceStats = unescapeJson('{{deviceStats}}');
                    searchAnalytics = unescapeJson('{{searchAnalytics}}');
                    economicActivity = unescapeJson('{{economicActivity}}');
                    
                    console.log('Parsed data:', {
                        topPlaces: topPlaces.length,
                        topCategories: topCategories.length,
                        dailyStats: dailyStats.length,
                        hourlyStats: hourlyStats.length,
                        deviceStats: deviceStats.length,
                        searchAnalytics: searchAnalytics.length,
                        economicActivity: economicActivity.length
                    });
                } catch (e) {
                    console.error('Error parsing data:', e);
                    topPlaces = [];
                    topCategories = [];
                    dailyStats = [];
                    hourlyStats = [];
                    deviceStats = [];
                    searchAnalytics = [];
                    economicActivity = [];
                }

                // Parse tour and merchant analytics
                let tourAnalytics = {};
                let merchantAnalytics = {};
                try {
                    const tourAnalyticsStr = '{{tourAnalytics}}';
                    const merchantAnalyticsStr = '{{merchantAnalytics}}';
                    if (tourAnalyticsStr && tourAnalyticsStr !== '{{tourAnalytics}}') {
                        tourAnalytics = JSON.parse(tourAnalyticsStr);
                    }
                    if (merchantAnalyticsStr && merchantAnalyticsStr !== '{{merchantAnalytics}}') {
                        merchantAnalytics = JSON.parse(merchantAnalyticsStr);
                    }
                } catch (e) {
                    console.error('Error parsing tour/merchant analytics:', e);
                }

                // Populate top places table
                const placesTable = document.getElementById('top-places-table');
                if (placesTable && topPlaces.length > 0) {
                    topPlaces.slice(0, 10).forEach((place, index) => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${index + 1}</td>
                            <td>${place.place_name || 'N/A'}</td>
                            <td>${place.view_count || 0}</td>
                        `;
                        placesTable.appendChild(row);
                    });
                }

                // Populate top categories table
                const categoriesTable = document.getElementById('top-categories-table');
                if (categoriesTable && topCategories.length > 0) {
                    topCategories.slice(0, 10).forEach((category) => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${category.category || 'N/A'}</td>
                            <td>${category.view_count || 0}</td>
                        `;
                        categoriesTable.appendChild(row);
                    });
                }

                // Create Daily Activity Chart
                if (dailyStats.length > 0 && typeof Chart !== 'undefined') {
                    const dailyCtx = document.getElementById('dailyChart');
                    if (dailyCtx) {
                        const labels = dailyStats.map(d => {
                            const date = new Date(d.date);
                            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                        });
                        const eventData = dailyStats.map(d => d.event_count || 0);
                        const userData = dailyStats.map(d => d.unique_users || 0);
                        
                        new Chart(dailyCtx, {
                            type: 'line',
                            data: {
                                labels: labels,
                                datasets: [{
                                    label: 'Events',
                                    data: eventData,
                                    borderColor: '#667eea',
                                    backgroundColor: 'rgba(102, 126, 234, 0.1)',
                                    tension: 0.4,
                                    fill: true
                                }, {
                                    label: 'Unique Users',
                                    data: userData,
                                    borderColor: '#764ba2',
                                    backgroundColor: 'rgba(118, 75, 162, 0.1)',
                                    tension: 0.4,
                                    fill: true
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: {
                                    legend: {
                                        position: 'top',
                                    },
                                    title: {
                                        display: true,
                                        text: 'Daily Activity Over Time'
                                    }
                                },
                                scales: {
                                    y: {
                                        beginAtZero: true
                                    }
                                }
                            }
                        });
                    }
                }

                // Create Hourly Activity Chart (Peak Usage Hours)
                if (hourlyStats.length > 0 && typeof Chart !== 'undefined') {
                    const hourlyCtx = document.getElementById('hourlyChart');
                    if (hourlyCtx) {
                        const labels = hourlyStats.map(h => {
                            const hour = parseInt(h.hour);
                            return hour.toString().padStart(2, '0') + ':00';
                        });
                        const eventData = hourlyStats.map(h => h.event_count || 0);
                        const userData = hourlyStats.map(h => h.unique_users || 0);
                        
                        new Chart(hourlyCtx, {
                            type: 'line',
                            data: {
                                labels: labels,
                                datasets: [{
                                    label: 'Events',
                                    data: eventData,
                                    borderColor: 'rgba(75, 192, 192, 1)',
                                    backgroundColor: 'rgba(75, 192, 192, 0.2)',
                                    tension: 0.4,
                                    fill: true
                                }, {
                                    label: 'Users',
                                    data: userData,
                                    borderColor: 'rgba(153, 102, 255, 1)',
                                    backgroundColor: 'rgba(153, 102, 255, 0.2)',
                                    tension: 0.4,
                                    fill: false
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: {
                                    legend: { position: 'top' }
                                },
                                scales: {
                                    y: { beginAtZero: true }
                                }
                            }
                        });
                    }
                }

                // Create User Engagement Trends Chart
                if (dailyStats.length > 0 && typeof Chart !== 'undefined') {
                    const engagementCtx = document.getElementById('engagementChart');
                    if (engagementCtx) {
                        const labels = dailyStats.map(d => {
                            const date = new Date(d.date);
                            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                        });
                        
                        new Chart(engagementCtx, {
                            type: 'line',
                            data: {
                                labels: labels,
                                datasets: [{
                                    label: 'Daily Events',
                                    data: dailyStats.map(d => d.event_count || 0),
                                    borderColor: 'rgba(75, 192, 192, 1)',
                                    backgroundColor: 'rgba(75, 192, 192, 0.1)',
                                    tension: 0.4,
                                    fill: true
                                }, {
                                    label: 'Active Users',
                                    data: dailyStats.map(d => d.unique_users || 0),
                                    borderColor: 'rgba(255, 99, 132, 1)',
                                    backgroundColor: 'rgba(255, 99, 132, 0.1)',
                                    tension: 0.4,
                                    fill: true
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: {
                                    legend: { position: 'top' }
                                },
                                scales: {
                                    y: { beginAtZero: true }
                                }
                            }
                        });
                    }
                }

                // Create Device & Browser Usage Chart
                if (deviceStats.length > 0 && typeof Chart !== 'undefined') {
                    const deviceCtx = document.getElementById('deviceChart');
                    if (deviceCtx) {
                        new Chart(deviceCtx, {
                            type: 'doughnut',
                            data: {
                                labels: deviceStats.slice(0, 8).map(d => `${d.device_type || 'Unknown'} (${d.browser || 'Unknown'})`),
                                datasets: [{
                                    data: deviceStats.slice(0, 8).map(d => d.count),
                                    backgroundColor: [
                                        'rgba(255, 99, 132, 0.6)', 'rgba(54, 162, 235, 0.6)', 'rgba(255, 206, 86, 0.6)',
                                        'rgba(75, 192, 192, 0.6)', 'rgba(153, 102, 255, 0.6)', 'rgba(255, 159, 64, 0.6)',
                                        'rgba(199, 199, 199, 0.6)', 'rgba(83, 102, 255, 0.6)'
                                    ],
                                    borderColor: [
                                        'rgba(255, 99, 132, 1)', 'rgba(54, 162, 235, 1)', 'rgba(255, 206, 86, 1)',
                                        'rgba(75, 192, 192, 1)', 'rgba(153, 102, 255, 1)', 'rgba(255, 159, 64, 1)',
                                        'rgba(199, 199, 199, 1)', 'rgba(83, 102, 255, 1)'
                                    ],
                                    borderWidth: 1
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: {
                                    legend: { position: 'right' }
                                }
                            }
                        });
                    }
                }

                // Create Top Places Chart
                if (topPlaces.length > 0 && typeof Chart !== 'undefined') {
                    const topPlacesCtx = document.getElementById('topPlacesChart');
                    if (topPlacesCtx) {
                        new Chart(topPlacesCtx, {
                            type: 'bar',
                            data: {
                                labels: topPlaces.slice(0, 10).map(p => p.place_name || 'Unknown'),
                                datasets: [{
                                    label: 'Views',
                                    data: topPlaces.slice(0, 10).map(p => p.view_count || 0),
                                    backgroundColor: 'rgba(54, 162, 235, 0.6)',
                                    borderColor: 'rgba(54, 162, 235, 1)',
                                    borderWidth: 1
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                indexAxis: 'y',
                                plugins: {
                                    legend: { display: false }
                                },
                                scales: {
                                    x: { beginAtZero: true }
                                }
                            }
                        });
                    }
                }

                // Create Top Categories Chart
                if (topCategories.length > 0 && typeof Chart !== 'undefined') {
                    const topCategoriesCtx = document.getElementById('topCategoriesChart');
                    if (topCategoriesCtx) {
                        new Chart(topCategoriesCtx, {
                            type: 'bar',
                            data: {
                                labels: topCategories.slice(0, 10).map(c => c.category || 'Unknown'),
                                datasets: [{
                                    label: 'Views',
                                    data: topCategories.slice(0, 10).map(c => c.view_count || 0),
                                    backgroundColor: 'rgba(255, 99, 132, 0.6)',
                                    borderColor: 'rgba(255, 99, 132, 1)',
                                    borderWidth: 1
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                indexAxis: 'y',
                                plugins: {
                                    legend: { display: false }
                                },
                                scales: {
                                    x: { beginAtZero: true }
                                }
                            }
                        });
                    }
                }

                // Create Search Analytics Chart
                if (searchAnalytics.length > 0 && typeof Chart !== 'undefined') {
                    const searchCtx = document.getElementById('searchChart');
                    if (searchCtx) {
                        new Chart(searchCtx, {
                            type: 'bar',
                            data: {
                                labels: searchAnalytics.slice(0, 10).map(s => s.query || 'Unknown'),
                                datasets: [{
                                    label: 'Search Count',
                                    data: searchAnalytics.slice(0, 10).map(s => s.search_count || 0),
                                    backgroundColor: 'rgba(255, 159, 64, 0.6)',
                                    borderColor: 'rgba(255, 159, 64, 1)',
                                    borderWidth: 1
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                indexAxis: 'y',
                                plugins: {
                                    legend: { display: false }
                                },
                                scales: {
                                    x: { beginAtZero: true }
                                }
                            }
                        });
                    }
                }

                // Create Economic Activity Chart
                if (economicActivity.length > 0 && typeof Chart !== 'undefined') {
                    const economicCtx = document.getElementById('economicChart');
                    if (economicCtx) {
                        new Chart(economicCtx, {
                            type: 'bar',
                            data: {
                                labels: economicActivity.slice(0, 10).map(e => e.place_name || 'Unknown'),
                                datasets: [{
                                    label: 'Interactions',
                                    data: economicActivity.slice(0, 10).map(e => e.interactions || 0),
                                    backgroundColor: 'rgba(34, 197, 94, 0.6)',
                                    borderColor: 'rgba(34, 197, 94, 1)',
                                    borderWidth: 1
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                indexAxis: 'y',
                                plugins: {
                                    legend: { display: false }
                                },
                                scales: {
                                    x: { beginAtZero: true }
                                }
                            }
                        });
                    }
                }

                // Render Tour Analytics Charts
                if (tourAnalytics.mostViewedTours && tourAnalytics.mostViewedTours.length > 0) {
                    const ctx = document.getElementById('mostViewedToursChart');
                    if (ctx) {
                        new Chart(ctx, {
                            type: 'bar',
                            data: {
                                labels: tourAnalytics.mostViewedTours.map(t => t.tour_name || 'Unknown'),
                                datasets: [{
                                    label: 'Views',
                                    data: tourAnalytics.mostViewedTours.map(t => t.view_count || 0),
                                    backgroundColor: 'rgba(54, 162, 235, 0.6)',
                                    borderColor: 'rgba(54, 162, 235, 1)',
                                    borderWidth: 1
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                indexAxis: 'y',
                                plugins: { legend: { display: false } },
                                scales: { x: { beginAtZero: true } }
                            }
                        });
                    }
                }

                if (tourAnalytics.mostBookedTours && tourAnalytics.mostBookedTours.length > 0) {
                    const ctx = document.getElementById('mostBookedToursChart');
                    if (ctx) {
                        new Chart(ctx, {
                            type: 'bar',
                            data: {
                                labels: tourAnalytics.mostBookedTours.map(t => t.tour_name || 'Unknown'),
                                datasets: [{
                                    label: 'Bookings',
                                    data: tourAnalytics.mostBookedTours.map(t => t.booking_count || 0),
                                    backgroundColor: 'rgba(75, 192, 192, 0.6)',
                                    borderColor: 'rgba(75, 192, 192, 1)',
                                    borderWidth: 1
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                indexAxis: 'y',
                                plugins: { legend: { display: false } },
                                scales: { x: { beginAtZero: true } }
                            }
                        });
                    }
                }

                if (tourAnalytics.tourRevenue && tourAnalytics.tourRevenue.length > 0) {
                    const ctx = document.getElementById('tourRevenueChart');
                    if (ctx) {
                        new Chart(ctx, {
                            type: 'bar',
                            data: {
                                labels: tourAnalytics.tourRevenue.map(t => t.tour_name || 'Unknown'),
                                datasets: [{
                                    label: 'Revenue (EUR)',
                                    data: tourAnalytics.tourRevenue.map(t => t.total_revenue || 0),
                                    backgroundColor: 'rgba(255, 99, 132, 0.6)',
                                    borderColor: 'rgba(255, 99, 132, 1)',
                                    borderWidth: 1
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                indexAxis: 'y',
                                plugins: { legend: { display: false } },
                                scales: { 
                                    x: { 
                                        beginAtZero: true,
                                        ticks: { callback: function(value) { return '€' + value.toFixed(2); } }
                                    } 
                                }
                            }
                        });
                    }
                }

                if (tourAnalytics.ticketsSold && tourAnalytics.ticketsSold.length > 0) {
                    const ctx = document.getElementById('ticketsSoldChart');
                    if (ctx) {
                        new Chart(ctx, {
                            type: 'bar',
                            data: {
                                labels: tourAnalytics.ticketsSold.map(t => t.tour_name || 'Unknown'),
                                datasets: [{
                                    label: 'Tickets',
                                    data: tourAnalytics.ticketsSold.map(t => t.tickets_sold || 0),
                                    backgroundColor: 'rgba(153, 102, 255, 0.6)',
                                    borderColor: 'rgba(153, 102, 255, 1)',
                                    borderWidth: 1
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                indexAxis: 'y',
                                plugins: { legend: { display: false } },
                                scales: { x: { beginAtZero: true } }
                            }
                        });
                    }
                }

                if (tourAnalytics.abandonedCheckouts && tourAnalytics.abandonedCheckouts.length > 0) {
                    const ctx = document.getElementById('checkoutAbandonmentChart');
                    if (ctx) {
                        new Chart(ctx, {
                            type: 'bar',
                            data: {
                                labels: tourAnalytics.abandonedCheckouts.map(t => t.tour_name || 'Unknown'),
                                datasets: [{
                                    label: 'Abandoned',
                                    data: tourAnalytics.abandonedCheckouts.map(t => t.abandoned_count || 0),
                                    backgroundColor: 'rgba(255, 159, 64, 0.6)',
                                    borderColor: 'rgba(255, 159, 64, 1)',
                                    borderWidth: 1
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                indexAxis: 'y',
                                plugins: { legend: { display: false } },
                                scales: { x: { beginAtZero: true } }
                            }
                        });
                    }
                }

                // Populate unpaid tours table
                const unpaidTable = document.getElementById('unpaidToursTable');
                if (unpaidTable && tourAnalytics.unpaidTours && tourAnalytics.unpaidTours.length > 0) {
                    const tbody = unpaidTable.querySelector('tbody');
                    if (tbody) {
                        tourAnalytics.unpaidTours.slice(0, 20).forEach(item => {
                            const row = document.createElement('tr');
                            row.innerHTML = `
                                <td>${item.tour_name || 'Unknown'}</td>
                                <td>${item.contact_email || item.user_id || 'N/A'}</td>
                                <td>€${(item.total_price || 0).toFixed(2)}</td>
                                <td>${new Date(item.created_at).toLocaleDateString()}</td>
                            `;
                            tbody.appendChild(row);
                        });
                    }
                }

                // Render Merchant Analytics Charts
                if (merchantAnalytics.merchantScans && merchantAnalytics.merchantScans.length > 0) {
                    const ctx = document.getElementById('merchantScansChart');
                    if (ctx) {
                        new Chart(ctx, {
                            type: 'bar',
                            data: {
                                labels: merchantAnalytics.merchantScans.map(m => m.merchant_name || m.business_name || 'Unknown'),
                                datasets: [{
                                    label: 'Scans',
                                    data: merchantAnalytics.merchantScans.map(m => m.scan_count || 0),
                                    backgroundColor: 'rgba(34, 197, 94, 0.6)',
                                    borderColor: 'rgba(34, 197, 94, 1)',
                                    borderWidth: 1
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                indexAxis: 'y',
                                plugins: { legend: { display: false } },
                                scales: { x: { beginAtZero: true } }
                            }
                        });
                    }
                }

                if (merchantAnalytics.merchantRevenue && merchantAnalytics.merchantRevenue.length > 0) {
                    const ctx = document.getElementById('merchantRevenueChart');
                    if (ctx) {
                        new Chart(ctx, {
                            type: 'bar',
                            data: {
                                labels: merchantAnalytics.merchantRevenue.map(m => m.merchant_name || m.business_name || 'Unknown'),
                                datasets: [{
                                    label: 'Revenue (EUR)',
                                    data: merchantAnalytics.merchantRevenue.map(m => m.total_revenue || 0),
                                    backgroundColor: 'rgba(59, 130, 246, 0.6)',
                                    borderColor: 'rgba(59, 130, 246, 1)',
                                    borderWidth: 1
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                indexAxis: 'y',
                                plugins: { legend: { display: false } },
                                scales: { 
                                    x: { 
                                        beginAtZero: true,
                                        ticks: { callback: function(value) { return '€' + value.toFixed(2); } }
                                    } 
                                }
                            }
                        });
                    }
                }

                if (merchantAnalytics.merchantReservations && merchantAnalytics.merchantReservations.length > 0) {
                    const ctx = document.getElementById('merchantReservationsChart');
                    if (ctx) {
                        new Chart(ctx, {
                            type: 'bar',
                            data: {
                                labels: merchantAnalytics.merchantReservations.map(m => m.merchant_name || m.business_name || 'Unknown'),
                                datasets: [{
                                    label: 'Reservations',
                                    data: merchantAnalytics.merchantReservations.map(m => m.reservation_count || 0),
                                    backgroundColor: 'rgba(168, 85, 247, 0.6)',
                                    borderColor: 'rgba(168, 85, 247, 1)',
                                    borderWidth: 1
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                indexAxis: 'y',
                                plugins: { legend: { display: false } },
                                scales: { x: { beginAtZero: true } }
                            }
                        });
                    }
                }

                if (merchantAnalytics.merchantUnused && merchantAnalytics.merchantUnused.length > 0) {
                    const ctx = document.getElementById('merchantUnusedChart');
                    if (ctx) {
                        new Chart(ctx, {
                            type: 'bar',
                            data: {
                                labels: merchantAnalytics.merchantUnused.map(m => m.merchant_name || m.business_name || 'Unknown'),
                                datasets: [{
                                    label: 'Unused',
                                    data: merchantAnalytics.merchantUnused.map(m => m.unused_count || 0),
                                    backgroundColor: 'rgba(239, 68, 68, 0.6)',
                                    borderColor: 'rgba(239, 68, 68, 1)',
                                    borderWidth: 1
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                indexAxis: 'y',
                                plugins: { legend: { display: false } },
                                scales: { x: { beginAtZero: true } }
                            }
                        });
                    }
                }
            } catch (e) {
                console.error('Error populating data:', e);
            }
        })();
    </script>
</body>
</html>

